<?xml version="1.0"?>
<!--
/**
 * PageCache powered by Varnish
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to support@phoenix-media.eu so we can send you a copy immediately.
 *
 * @category   Phoenix
 * @package    Phoenix_VarnishCache
 * @copyright  Copyright (c) 2011 PHOENIX MEDIA GmbH & Co. KG (http://www.phoenix-media.de)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
-->
<config>
    <modules>
        <Phoenix_VarnishCache>
            <version>3.0.1</version>
        </Phoenix_VarnishCache>
    </modules>
    <global>
        <models>
            <varnishcache>
                <class>Phoenix_VarnishCache_Model</class>
                <resourceModel>varnishcache_resource_mysql4</resourceModel>
            </varnishcache>
            <varnishcache_resource_mysql4>
                <class>Phoenix_VarnishCache_Model_Resource_Mysql4</class>
            </varnishcache_resource_mysql4>

            <core>
                <rewrite>
                    <url>Phoenix_VarnishCache_Model_Core_Url</url>
                </rewrite>
            </core>
        </models>
        <helpers>
            <varnishcache>
                <class>Phoenix_VarnishCache_Helper</class>
            </varnishcache>
            <core>
                <rewrite>
                    <url>Phoenix_VarnishCache_Helper_Core_Url</url>
                </rewrite>
            </core>
            <checkout>
                <rewrite>
                    <cart>Phoenix_VarnishCache_Helper_Checkout_Cart</cart>
                </rewrite>
            </checkout>
        </helpers>
        <blocks>
            <varnishcache>
                <class>Phoenix_VarnishCache_Block</class>
            </varnishcache>
        </blocks>
        <resources>
            <phoenix_varnishcache_setup>
                <setup>
                    <module>Phoenix_VarnishCache</module>
                </setup>
            </phoenix_varnishcache_setup>
        </resources>
        <events>
            <!-- clean varnish page cache together with magento -->
            <adminhtml_cache_flush_all>
                <observers>
                    <varnishcache>
                        <type>singleton</type>
                        <class>varnishcache/observer</class>
                        <method>cleanCache</method>
                    </varnishcache>
                </observers>
            </adminhtml_cache_flush_all>
            <adminhtml_cache_flush_system>
                <observers>
                    <varnishcache>
                        <type>singleton</type>
                        <class>varnishcache/observer</class>
                        <method>cleanCache</method>
                    </varnishcache>
                </observers>
            </adminhtml_cache_flush_system>

            <!-- purge product cache after stock update -->
            <cataloginventory_stock_item_save_after>
                <observers>
                    <phoenix_varnishcache>
                        <class>varnishcache/observer</class>
                        <method>purgeCatalogProductByStock</method>
                    </phoenix_varnishcache>
                </observers>
            </cataloginventory_stock_item_save_after>

            <!-- purge product cache after review added/modified -->
            <review_save_after>
                <observers>
                    <phoenix_varnishcache>
                        <class>varnishcache/observer</class>
                        <method>purgeCatalogProductByReview</method>
                    </phoenix_varnishcache>
                </observers>
            </review_save_after>

            <blog_post_save_after>
                <observers>
                    <phoenix_varnishcache_blog_post>
                        <class>varnishcache/observer</class>
                        <method>purgeBlogByPost</method>
                    </phoenix_varnishcache_blog_post>
                </observers>
            </blog_post_save_after>
            <blog_comment_save_after>
                <observers>
                    <phoenix_varnishcache_blog_comment>
                        <class>varnishcache/observer</class>
                        <method>purgeBlogByComment</method>
                    </phoenix_varnishcache_blog_comment>
                </observers>
            </blog_comment_save_after>
        </events>
    </global>
    <admin>
        <routers>
            <adminhtml>
                <args>
                    <modules>
                        <Phoenix_VarnishCache before="Mage_Adminhtml">Phoenix_VarnishCache_Adminhtml</Phoenix_VarnishCache>
                    </modules>
                </args>
            </adminhtml>
        </routers>
    </admin>
    <adminhtml>
        <layout>
            <updates>
                <varnishcache>
                    <file>varnishcache.xml</file>
                </varnishcache>
            </updates>
        </layout>
        <translate>
            <modules>
                <Phoenix_VarnishCache>
                    <files>
                        <default>Phoenix_VarnishCache.csv</default>
                    </files>
                </Phoenix_VarnishCache>
            </modules>
        </translate>
        <events>
            <!-- disable page caching for all admin requests -->
            <controller_action_predispatch_adminhtml>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>disablePageCaching</method>
                    </varnishcache>
                </observers>
            </controller_action_predispatch_adminhtml>

            <!-- clean varnish js/css cache together with magento -->
            <clean_media_cache_after>
                <observers>
                    <enterprise_pagecache>
                        <class>varnishcache/observer</class>
                        <method>cleanMediaCache</method>
                    </enterprise_pagecache>
                </observers>
            </clean_media_cache_after>

            <!-- clean varnish catalog images cache together with magento -->
            <clean_catalog_images_cache_after>
                <observers>
                    <enterprise_pagecache>
                        <class>varnishcache/observer</class>
                        <method>cleanCatalogImagesCache</method>
                    </enterprise_pagecache>
                </observers>
            </clean_catalog_images_cache_after>

            <!-- purge category cache after save -->
            <catalog_category_save_after>
                <observers>
                    <phoenix_varnishcache>
                        <class>varnishcache/observer</class>
                        <method>purgeCatalogCategory</method>
                    </phoenix_varnishcache>
                </observers>
            </catalog_category_save_after>

            <!-- purge product cache after save -->
            <catalog_product_save_after>
                <observers>
                    <phoenix_varnishcache>
                        <class>varnishcache/observer</class>
                        <method>purgeCatalogProduct</method>
                    </phoenix_varnishcache>
                </observers>
            </catalog_product_save_after>

            <!-- purge cms page cache after save -->
            <cms_page_save_after>
                <observers>
                    <phoenix_varnishcache>
                        <class>varnishcache/observer</class>
                        <method>purgeCmsPage</method>
                    </phoenix_varnishcache>
                </observers>
            </cms_page_save_after>

            <custommenu_save_after>
                <observers>
                    <phoenix_varnishcache_custommenu>
                        <class>varnishcache/observer</class>
                        <method>purgeMenu</method>
                    </phoenix_varnishcache_custommenu>
                </observers>
            </custommenu_save_after>

        </events>
    </adminhtml>
    <frontend>
        <routers>
            <phoenix_varnishcache>
                <use>standard</use>
                <args>
                    <module>Phoenix_VarnishCache</module>
                    <frontName>varnishcache</frontName>
                </args>
            </phoenix_varnishcache>
        </routers>
        <layout>
            <updates>
                <varnishcache>
                    <file>varnishcache.xml</file>
                </varnishcache>
            </updates>
        </layout>
        <events>
            <!-- add cache headers -->
            <controller_action_postdispatch>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>setCacheControlHeaders</method>
                    </varnishcache>
                </observers>
            </controller_action_postdispatch>
            <http_response_send_before>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>sanitizeCacheControlHeader</method>
                    </varnishcache>
                    <formkey>
                        <class>varnishcache/observer</class>
                        <type>singleton</type>
                        <method>replaceFormkey</method>
                    </formkey>
                    <personalisation_cookie_check>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>checkHasPersonalisationCookie</method>
                    </personalisation_cookie_check>
                    <personalisation_cookie_set>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>setPersonalisationCookie</method>
                    </personalisation_cookie_set>
                </observers>
            </http_response_send_before>

            <!-- stop page caching at visitor interaction -->
            <core_session_abstract_add_message>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>checkDisableCachingOnAddMessage</method>
                    </varnishcache>
                </observers>
            </core_session_abstract_add_message>
            <checkout_cart_product_add_after>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>checkDisableCachingOnAddToCart</method>
                    </varnishcache>
                </observers>
            </checkout_cart_product_add_after>
            <checkout_cart_save_after>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                </observers>
            </checkout_cart_save_after>
            <customer_login>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>checkDisableCachingOnLogin</method>
                    </varnishcache>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                </observers>
            </customer_login>
            <customer_save_after>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                </observers>
            </customer_save_after>
            <customer_logout>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>deletePersonalisationCookie</method>
                    </personalisation_cookie_update>
                </observers>
            </customer_logout>
            <catalog_product_compare_add_product>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>checkDisableCachingOnAddToCompare</method>
                    </varnishcache>
                </observers>
            </catalog_product_compare_add_product>
            <wishlist_add_product>
                <observers>
                    <varnishcache>
                        <class>varnishcache/observer</class>
                        <method>checkDisableCachingOnAddToWishlist</method>
                    </varnishcache>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                    <set_message_cookie>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>setMessageCookie</method>
                    </set_message_cookie>
                </observers>
            </wishlist_add_product>
            <wishlist_update_item>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                    <set_message_cookie>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>setMessageCookie</method>
                    </set_message_cookie>
                </observers>
            </wishlist_update_item>
            <controller_action_postdispatch_wishlist_index_update>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                    <set_message_cookie>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>setMessageCookie</method>
                    </set_message_cookie>
                </observers>
            </controller_action_postdispatch_wishlist_index_update>

            <controller_action_postdispatch_wishlist_index_remove>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                    <set_message_cookie>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>setMessageCookie</method>
                    </set_message_cookie>
                </observers>
            </controller_action_postdispatch_wishlist_index_remove>

            <controller_action_postdispatch_checkout_cart_index>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                </observers>
            </controller_action_postdispatch_checkout_cart_index>
            <controller_action_postdispatch_checkout_cart_add>
                <observers>
                    <set_message_cookie>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>setMessageCookie</method>
                    </set_message_cookie>
                </observers>
            </controller_action_postdispatch_checkout_cart_add>
            <checkout_onepage_controller_success_action>
                <observers>
                    <personalisation_cookie_update>
                        <type>singleton</type>
                        <class>varnishcache/personalisationcookie</class>
                        <method>updatePersonalisationCookie</method>
                    </personalisation_cookie_update>
                </observers>
            </checkout_onepage_controller_success_action>

            <controller_action_predispatch_checkout_cart_add>
                <observers>
                    <fix_formkey_cart>
                        <type>singleton</type>
                        <class>varnishcache/observer</class>
                        <method>bypassFormKeyCart</method>
                    </fix_formkey_cart>
                </observers>
            </controller_action_predispatch_checkout_cart_add>
            <controller_action_predispatch_review_product_post>
                <observers>
                    <fix_formkey_review>
                        <type>singleton</type>
                        <class>varnishcache/observer</class>
                        <method>bypassFormReview</method>
                    </fix_formkey_review>
                </observers>
            </controller_action_predispatch_review_product_post>
        </events>
    </frontend>
    <default>
        <system>
            <varnishcache>
                <enabled>0</enabled>
                <enabled_form_key>1</enabled_form_key>
                <servers>localhost</servers>
                <port>80</port>
                <disable_caching>0</disable_caching>
                <disable_routes><![CDATA[checkout
customer
moneybookers
paypal
wishlist]]></disable_routes>
                <disable_caching_vars><![CDATA[___store,___SID,currency,order]]></disable_caching_vars>
                <disable_on_add_message>1</disable_on_add_message>
                <disable_on_add_to_cart>1</disable_on_add_to_cart>
                <disable_on_login>1</disable_on_login>
                <disable_on_add_to_compare>1</disable_on_add_to_compare>
                <disable_on_add_to_wishlist>1</disable_on_add_to_wishlist>                
                <ttl>14400</ttl>
                <routes_ttl>a:3:{s:1:"1";a:2:{s:6:"regexp";s:3:"cms";s:5:"value";s:5:"86400";}s:1:"2";a:2:{s:6:"regexp";s:20:"catalog_product_view";s:5:"value";s:4:"7200";}s:1:"3";a:2:{s:6:"regexp";s:16:"catalog_category";s:5:"value";s:5:"21600";}}</routes_ttl>
                <purge_catalog_category>0</purge_catalog_category>
                <purge_catalog_product>0</purge_catalog_product>
                <purge_cms_page>0</purge_cms_page>
                <purge_blog>0</purge_blog>
                <debug>0</debug>
            </varnishcache>
            <personalisation_cookie>
                <enabled>1</enabled>
                <cookie_key>personalisation</cookie_key>
                <send_to_all_users>0</send_to_all_users>
                <send_cart_count>1</send_cart_count>
                <selector_cart_count>#cart-count</selector_cart_count>
                <send_cart_subtotal>1</send_cart_subtotal>
                <selector_cart_subtotal>#cart-subtotal</selector_cart_subtotal>
                <send_wishlist_count>1</send_wishlist_count>
                <selector_wishlist_count>#wishlist-count</selector_wishlist_count>
                <send_customer_first_name>0</send_customer_first_name>
                <selector_customer_first_name>#customer-first-name</selector_customer_first_name>
                <send_customer_full_name>0</send_customer_full_name>
                <selector_customer_full_name>#customer-full-name</selector_customer_full_name>
                <send_customer_email>0</send_customer_email>
                <selector_customer_email>#customer-email</selector_customer_email>
                <enable_messages_cookie>1</enable_messages_cookie>
            </personalisation_cookie>
        </system>
    </default>
    <phpunit>
        <suite>
            <modules>
                <Phoenix_VarnishCache />
            </modules>
        </suite>
    </phpunit>
</config>
